
@{
    ViewData["Title"] = "ViewList";
    Layout = "~/Views/Shared/_CMSLayout.cshtml";
}
@model userregistrationEF.VTDVendorModel
<section class="wrapper main-wrapper row">

    <div class="col-12">
        @Html.Partial("_CMSnavigation")
        <!-- MAIN CONTENT AREA STARTS -->
        <div class="row">
            <div class="col-12">
                <div class="main-tab">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                View
                            </a>
                        </li>
                    </ul>
                    @Html.Partial("_CMSutil")
                </div>
                @using (Html.BeginForm("VTDUserForceDataView", "Contractor", FormMethod.Post, new { id = "__EUAntiForgeryForm", @enctype = "multipart/form-data", @class = "form-horizontal bordered-row" }))
                {
                    @Html.HiddenFor(model => model.Status)
                    @Html.HiddenFor(model => model.UserId)
                    @Html.HiddenFor(model => model.VTDVendorId)
                    @Html.HiddenFor(model => model.DSCResponse)
                    @Html.Hidden("approve")
                    @Html.Hidden("reject")
                    <section class="box form-container" id="printForcefullyData">
                        <div class="row">
                            <label class="col-sm-2 col-form-label">Company Name</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.CompanyName</label>
                            </div>

                            <label class="col-sm-2 col-form-label">GST</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.GST</label>
                            </div>
                        </div>

                        <h6>Company's Corporate Details</h6>


                        <div class="row">
                            <label class="col-sm-2 col-form-label">Address</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Corp_Address</label>
                            </div>

                            <label class="col-sm-2 col-form-label">State</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Corp_State_Name</label>
                            </div>

                            <label class="col-sm-2 col-form-label">District</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Corp_District_Name</label>
                            </div>

                            @*<label class="col-sm-2 col-form-label">Block</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Corp_Block</label>
                            </div>*@

                            <label class="col-sm-2 col-form-label">Pincode</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Corp_PinCode</label>
                            </div>

                        </div>

                        <h6>Company's Local Details</h6>

                        <div class="row">

                            <label class="col-sm-2 col-form-label">Address</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Local_Address</label>
                            </div>


                            <label class="col-sm-2 col-form-label">State</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.StateName</label>
                            </div>



                            <label class="col-sm-2 col-form-label">District</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.DistrictName</label>
                            </div>



                            <label class="col-sm-2 col-form-label">Block</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.BlockName</label>
                            </div>



                            <label class="col-sm-2 col-form-label">Pincode</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Company_Local_PinCode</label>
                            </div>

                        </div>
                        <h6>Primary Contact Details</h6>
                        <div class="row">

                            <label class="col-sm-2 col-form-label">Name</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Contact_Person_Name</label>
                            </div>


                            <label class="col-sm-2 col-form-label ">Mobile Number</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Contact_Person_MobileNo</label>
                            </div>



                            <label class="col-sm-2 col-form-label">Email-Id</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Contact_Person_EmailId</label>
                            </div>


                            <label class="col-sm-2 col-form-label ">Designation</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Contact_Person_Designation</label>
                            </div>
                        </div>

                        <h6>Secondary Contact Details</h6>
                        <div class="row">

                            <label class="col-sm-2 col-form-label">Name</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Secondary_Contact_Person_Name</label>
                            </div>


                            <label class="col-sm-2 col-form-label ">Mobile Number</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Secondary_Contact_Person_MobileNo</label>
                            </div>



                            <label class="col-sm-2 col-form-label">Email-Id</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Secondary_Contact_Person_EmailId</label>
                            </div>
                            <label class="col-sm-2 col-form-label">Designation</label>
                            <div class="col-sm-10">
                                <label class="form-control-plaintext"><span class="colon">:</span>@Model.Secondary_Designation</label>
                            </div>

                            <label class="col-sm-2 col-form-label ">Transport Department Approval Letter</label>
                            <div class="col-sm-10">
                                <a href="/Upload/VTDVendorDocument/@Model.Transport_Dept_ApprovalLetter" target="_blank" style="pointer-events:initial"><i class="icon-file-pdf-solid h4 text-danger"></i></a>
                            </div>



                            <label class="col-sm-2 col-form-label">Enter Remarks <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                                <textarea name="Remarks" id="Remarks" rows="3" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <input type="button" id="btn_Download" onclick="return onPrint();" value="Download" class="btn btn-primary btn-md ml-0" />
                                <input type="button" id="btn_Approve" onclick="onSubmit();" value="Approve" class="btn btn-success btn-md ml-0" />
                                <input type="button" id="btn_Reject" onclick="onSubmit1();" value="Reject" class="btn btn-danger btn-md ml-0" />
                            </div>
                        </div>
                    </section>
                }
            </div>
        </div>
    </div>
</section>
@{if (!string.IsNullOrEmpty(ViewBag.AcknowledgementMessage) && Convert.ToString(ViewBag.AcknowledgementMessage) == "1")
    {
        <script>
        window.location.href = "@Url.Action("VTDAllRequest", "Contractor", new { Area = "Contractor" })";
        </script>
    }
    else if (!string.IsNullOrEmpty(ViewBag.AcknowledgementMessage) && Convert.ToString(ViewBag.AcknowledgementMessage) == "2")
    {
        <script>
        window.location.href = "@Url.Action("VTDAllRequest", "Contractor", new { Area = "Contractor" })";
        </script>
    }
    else if (!string.IsNullOrEmpty(ViewBag.AcknowledgementMessage) && Convert.ToString(ViewBag.AcknowledgementMessage) == "0")
    {
        <script>
                swal("", "Something went wrong !", "warning");
        window.location.href = "@Url.Action("VTDAllRequest", "Contractor", new { Area = "Contractor" })";
        </script>
    }
}
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
<script>
    backMe = "yes"
    $(document).ready(function () {
        loadNavigation('AddUser', 'glRoleRes', 'plUser', 'tl', 'VTD User', 'User Request', ' ');
    });

    function Validate() {
        var Iss = false;
        if (!blankFieldValidation("Remarks", "Remarks")) {
            return false;
        }
        Iss = true;
        return Iss;
    }

    function onPrint() {
        debugger;
        var HTML_Width = $("#printForcefullyData").width();
        var HTML_Height = $("#printForcefullyData").height();
        var top_left_margin = 15;
        var PDF_Width = HTML_Width + (top_left_margin * 2);
        var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
        var canvas_image_width = HTML_Width;
        var canvas_image_height = HTML_Height;
        var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;
        html2canvas($("#printForcefullyData")[0], { allowTaint: true }).then(function (canvas) {
            debugger;
            canvas.getContext('2d');

            console.log(canvas.height + "  " + canvas.width);


            var data = canvas.toDataURL("image/JPEG", 1.0);
            var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
            pdf.addImage(data, 'JPEG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);


            for (var i = 1; i <= totalPDFPages; i++) {
                pdf.addPage(PDF_Width, PDF_Height);
                pdf.addImage(data, 'JPEG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
            }

            data = pdf.save("VTDUserForcefullyDataCapture.pdf");

        });
    }

    function onSubmit() {
        Validate();
        $('#approve').val("approve");
        if (confirm("Before approving application, you need to have valid Digital Signature. Please validate your application with Digital Signature??")) {


            var Postdata = 'action=signdoc' + "\n" + 'datatosign=Digital Signature Required' + "\n" + 'signaction=sign' + "\n" + 'filepath=' + "\n" + 'panNumberParam=' + "\n" + 'expirycheck=false' + "\n" + 'issuername=' + "\n" + 'certclass=1|2|3' + "\n" + 'certtype=ALL';
            connection.send(Postdata);

            connection.onerror = function (error) {
                alert('Please check the server connection: ' + error);
                alert(error);
                return false;
            };

            connection.onmessage = function (e) {
                if (e.data.indexOf("subProtocol") == -1) {

                    $("#DSCResponse").val(e.data).change();
                    $.ajax({
                        url: "/EndUserRegistration/EndUserProfile/CheckVerifyResponse",
                        type: "POST",
                        data: { contentType: "pkcs7", signDataBase64Encoded: e.data, responseType: "plain" },
                        success: function (msg) {
                            if (msg == "SUCCESS") {
                                $('#__EUAntiForgeryForm').submit();
                                return true;
                            }

                        }
                    });
                }
                else {
                    alert(e.data);
                    return false;
                }
                return false;
            };
            return false;
        }
        else {
            return false;
        }
    }

    function onSubmit1() {
        $('#reject').val("reject");
        if ($("#Remarks").val() != "") {
            if (confirm("Before rejecting application, you need to have valid Digital Signature. Please validate your application with Digital Signature??")) {

                var Postdata = 'action=signdoc' + "\n" + 'datatosign=Digital Signature Required' + "\n" + 'signaction=sign' + "\n" + 'filepath=' + "\n" + 'panNumberParam=' + "\n" + 'expirycheck=false' + "\n" + 'issuername=' + "\n" + 'certclass=1|2|3' + "\n" + 'certtype=ALL';
                connection.send(Postdata);

                connection.onerror = function (error) {
                    alert('Please check the server connection: ' + error);
                    alert(error);
                    return false;
                };

                connection.onmessage = function (e) {
                    if (e.data.indexOf("subProtocol") == -1) {
                        $("#DSCResponse").val(e.data).change();
                        $.ajax({
                            url: "/EndUserRegistration/EndUserProfile/CheckVerifyResponse",
                            type: "POST",
                            data: { contentType: "pkcs7", signDataBase64Encoded: e.data, responseType: "plain" },
                            success: function (msg) {
                                if (msg == "SUCCESS") {
                                    $('#__EUAntiForgeryForm').submit();
                                    return true;

                                }

                            }
                        });
                    }
                    else {
                        alert(e.data);
                        return false;
                    }

                };

                return false;

            }
            else {
                return false;
            }

        }
        else {
            $("#Remarks").focus();
            swal("", "Please Enter Remarks", "warning");
        }

    }



    //following code is for DSC Signature
    try {
        var connection = new WebSocket('wss://localhost.emudhra.com:8080');

        connection.onopen = function () {
            console.log('Connection Opened');
        };
        connection.onerror = function (error) {
            //  alert('Please check the DSC connection: ' + error);
        };
        connection.onmessage = function (e) {
            if (e.data.indexOf("subProtocol") == -1) {
                //  alert(e.data);
            }
        };
    }
    catch (e) {
        alert("No DSC Connection Found");
    }
    //-----------------------------
</script>
